# ADR-003: 数据持久化策略 - LocalStorage

## 状态
已接受 (2025-01-20)

## 背景
车险多维数据分析平台需要实现数据的本地持久化存储，以提升用户体验和数据安全性。用户上传的CSV数据需要在页面刷新或重新访问时能够自动恢复，同时需要记录上传历史以便追溯和管理。

## 决策
选择浏览器 LocalStorage 作为主要的数据持久化方案，结合文件哈希验证和分层存储策略。

## 理由

### 技术考虑
1. **浏览器兼容性**: LocalStorage 在所有现代浏览器中都有良好支持
2. **存储容量**: 通常提供 5-10MB 的存储空间，足够存储中等规模的CSV数据
3. **性能表现**: 同步API，读写性能优秀，无需异步处理复杂性
4. **数据持久性**: 数据在浏览器关闭后仍然保留，直到用户主动清理

### 业务需求
1. **离线可用**: 无需网络连接即可访问历史数据
2. **快速恢复**: 页面刷新后立即恢复数据状态
3. **历史追踪**: 完整记录每次上传的详细信息
4. **重复检测**: 基于文件内容哈希避免重复上传

### 安全考虑
1. **本地存储**: 数据仅存储在用户本地，不涉及服务器传输
2. **数据隔离**: 使用应用特定的键前缀避免冲突
3. **完整性验证**: 使用SHA-256哈希确保数据完整性

## 实现方案

### 存储结构
```typescript
// 主数据存储
localStorage.setItem('insuralytics_data', JSON.stringify(data))

// 元信息存储
localStorage.setItem('insuralytics_meta', JSON.stringify({
  lastUpdated: string,
  totalRecords: number,
  dataHash: string,
  uploadHistory: UploadHistoryRecord[]
}))
```

### 核心功能
1. **数据保存**: 上传成功后自动保存到LocalStorage
2. **数据加载**: 应用启动时自动检查并恢复数据
3. **哈希验证**: 使用文件内容哈希检测重复和验证完整性
4. **历史记录**: 维护详细的上传历史记录

### 容量管理
1. **存储监控**: 实时监控LocalStorage使用情况
2. **优雅降级**: 存储失败时不影响核心功能
3. **清理机制**: 提供数据清理功能释放存储空间

## 替代方案

### IndexedDB
- **优点**: 更大存储容量，支持复杂查询
- **缺点**: 异步API增加复杂性，对于简单数据结构过于复杂

### SessionStorage
- **优点**: 会话级别存储，自动清理
- **缺点**: 浏览器关闭后数据丢失，不符合持久化需求

### WebSQL
- **优点**: SQL查询支持
- **缺点**: 已被废弃，浏览器支持有限

### 服务器存储
- **优点**: 无容量限制，跨设备同步
- **缺点**: 需要用户认证，增加系统复杂性，不符合本地化需求

## 影响

### 正面影响
1. **用户体验**: 数据自动保存和恢复，无需重复上传
2. **开发效率**: 简单的同步API，开发和调试容易
3. **系统稳定**: 本地存储避免网络依赖
4. **数据安全**: 数据不离开用户设备

### 负面影响
1. **存储限制**: 受浏览器存储配额限制
2. **设备绑定**: 数据无法跨设备访问
3. **清理风险**: 用户清理浏览器数据会丢失存储内容

### 风险缓解
1. **导出功能**: 提供数据导出功能作为备份
2. **容量提醒**: 接近存储限制时提醒用户
3. **优雅降级**: 存储失败时仍可正常使用应用

## 监控指标
1. **存储成功率**: 监控数据保存成功的比例
2. **恢复成功率**: 监控数据恢复成功的比例
3. **存储使用量**: 跟踪LocalStorage使用情况
4. **用户反馈**: 收集用户对持久化功能的反馈

## 相关决策
- [ADR-001: 状态管理选型 - Zustand](./ADR-001_状态管理选型-Zustand.md)
- [ADR-002: CSV解析策略 - 流式处理](./ADR-002_CSV解析策略-流式处理.md)

## 参考资料
- [Web Storage API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API)
- [LocalStorage 最佳实践](https://web.dev/storage-for-the-web/)
- [浏览器存储配额管理](https://web.dev/storage-quota/)